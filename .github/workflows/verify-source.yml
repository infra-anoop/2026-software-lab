# ------------------------------------------------------------------------------
# Verify Source (Nix)
# ------------------------------------------------------------------------------
# Runs on every pull request and on every push to main. Validates that the
# repo builds and passes all Nix checks (lint, unit tests, integration tests,
# container validation) and that the container derivation builds. Does not
# publish anything; use this to gate merges and catch breakage early.
# ------------------------------------------------------------------------------

name: "Verify Source (Nix)"

# When this workflow runs: PRs, pushes to main, or manual dispatch.
on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

# Prevent overlapping runs for the same ref; cancel an in-progress run if
# a new one is triggered (e.g. new push on the same branch).
concurrency:
  group: verify-${{ github.ref }}
  cancel-in-progress: true

jobs:
  verify:
    runs-on: ubuntu-latest
    # Read repo only; no need to write packages or the repo.
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Nix is installed with defaults; flake.lock pins nixpkgs (no nix_path).
      - name: Install Nix
        uses: cachix/install-nix-action@v25
        # No nix_path override: CI uses the flake's pinned nixpkgs (flake.lock), same as local.

      # Runs lint, test-unit, test-integration, validate-container.
      - name: Nix flake check
        run: nix flake check

      # Ensures the container image builds; artifact is not published.
      - name: Build container derivation
        run: nix build .#container
