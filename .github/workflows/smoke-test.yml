# ------------------------------------------------------------------------------
# Reusable: Post-Deploy Smoke Test (Railway)
# ------------------------------------------------------------------------------
# Verifies the live Railway deployment by curling RAILWAY_URL.
# NOT auto-triggered. Call via: ci-cd-pipeline.yml
# Requires: RAILWAY_URL secret
# ------------------------------------------------------------------------------

name: "Post-Deploy Smoke Test (Railway)"

on:
  workflow_call:
  workflow_dispatch:  # Manual run only; no auto-trigger

concurrency:
  group: smoke-${{ github.ref }}
  cancel-in-progress: true

jobs:
  smoke:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Smoke test Railway endpoint
        env:
          RAILWAY_URL: ${{ secrets.RAILWAY_URL }}
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${RAILWAY_URL:-}" ]]; then
            echo "ERROR: RAILWAY_URL secret is not set."
            exit 1
          fi

          echo "Testing: ${RAILWAY_URL}"

          curl -fsS -m 20 "${RAILWAY_URL}/health" || curl -fsS -m 20 "${RAILWAY_URL}/"

          echo "Smoke test OK"
