# ------------------------------------------------------------------------------
# Post-Deploy Smoke Test (Railway)
# ------------------------------------------------------------------------------
# Runs after "Deploy to Railway" completes (or manually). Verifies the live
# Railway deployment by curling RAILWAY_URL. Triggering after Deploy (not Ship)
# avoids the race where the new image is not yet deployed. Only runs when
# Deploy succeeded. Requires RAILWAY_URL repository (or org) secret.
# ------------------------------------------------------------------------------

name: "Post-Ship Smoke Test (Railway)"

# Triggered when Deploy to Railway finishes (so new image is live), or manually.
on:
  workflow_run:
    workflows: ["Deploy to Railway"]
    types: [completed]
  workflow_dispatch:

concurrency:
  group: smoke-${{ github.ref }}
  cancel-in-progress: true

jobs:
  smoke:
    # Run only when run manually or when the Deploy workflow succeeded.
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Smoke test Railway endpoint
        env:
          RAILWAY_URL: ${{ secrets.RAILWAY_URL }}
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${RAILWAY_URL:-}" ]]; then
            echo "ERROR: RAILWAY_URL secret is not set."
            exit 1
          fi

          echo "Testing: ${RAILWAY_URL}"

          # Prefer /health; if missing or non-2xx, try root path.
          curl -fsS -m 20 "${RAILWAY_URL}/health" || curl -fsS -m 20 "${RAILWAY_URL}/"

          echo "Smoke test OK"
