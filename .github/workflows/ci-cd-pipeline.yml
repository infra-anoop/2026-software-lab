# ------------------------------------------------------------------------------
# CI-CD Master Pipeline
# ------------------------------------------------------------------------------
# Single entry point for all CI/CD. Triggered on every push and pull_request.
# Calls reusable workflows which are NOT auto-triggered.
#
# FLOW:
#   - Every push / PR → verify
#   - Tag push v*     → verify → ship → deploy → smoke
# ------------------------------------------------------------------------------

name: "CI-CD Pipeline"

on:
  push:
  pull_request:
  workflow_dispatch:

concurrency:
  group: pipeline-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ─────────────────────────────────────────────────────────────────────────
  # Verify: every push, PR, manual
  # ─────────────────────────────────────────────────────────────────────────
  verify:
    name: Verify Source
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'push' && (github.ref_type == 'branch' || (github.ref_type == 'tag' && startsWith(github.ref_name, 'v'))))
    uses: ./.github/workflows/verify-source.yml

  # ─────────────────────────────────────────────────────────────────────────
  # Ship: only on version tag v*, after verify succeeds
  # ─────────────────────────────────────────────────────────────────────────
  ship:
    name: Ship Container
    needs: verify
    if:
      github.event_name == 'push' &&
      github.ref_type == 'tag' &&
      startsWith(github.ref_name, 'v')
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/ship-registry.yml

  # ─────────────────────────────────────────────────────────────────────────
  # Deploy: after ship succeeds (tag push only)
  # ─────────────────────────────────────────────────────────────────────────
  deploy:
    name: Deploy to Railway
    needs: ship
    if: success()  # Only when ship succeeded
    permissions:
      contents: read
      packages: read
    uses: ./.github/workflows/deploy.yml
    with:
      environment: production
      tag: latest

  # ─────────────────────────────────────────────────────────────────────────
  # Smoke: after deploy succeeds
  # ─────────────────────────────────────────────────────────────────────────
  smoke:
    name: Smoke Test
    needs: deploy
    if: success()  # Only when deploy succeeded
    uses: ./.github/workflows/smoke-test.yml
