name: "Build Test and Deploy"

# This section tells GitHub WHEN to run
on:
  push:
    branches:
      - main
  workflow_dispatch: # This adds a manual "Run" button in GitHub as a backup

jobs:
  industrial-pipeline:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-23.11

      - name: Run Nix Checks
        run: nix flake check

      - name: Build Application
        run: nix build .

      - name: Deploy to Railway
        # We manually inject the token right before the command
        run: RAILWAY_TOKEN=${{ secrets.RAILWAY_TOKEN }} npx @railway/cli up --service research-auditor -d